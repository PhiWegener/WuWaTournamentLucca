<h3>Pick/Ban</h3>

<p>
  Phase:
  {% if not banPhaseDone %}BAN{% elif not pickPhaseDone %}PICK{% else %}DONE{% endif %}
</p>

{% if isHost %}
  <form method="post" action="{% url 'matchDraftReset' match.id %}">
    {% csrf_token %}
    <button type="submit">Reset Draft</button>
  </form>
{% endif %}

<hr>

{# =======================
   BANS (final immer anzeigen)
   ======================= #}

<h4>Bans LEFT → RIGHT</h4>
<ul>
  {% for a in bansLeftToRight %}
    <li>Ban {{ a.slot_index }}: {{ a.resonator.name }}</li>
  {% empty %}
    <li>None</li>
  {% endfor %}
</ul>

<h4>Bans RIGHT → LEFT</h4>
<ul>
  {% for a in bansRightToLeft %}
    <li>Ban {{ a.slot_index }}: {{ a.resonator.name }}</li>
  {% empty %}
    <li>None</li>
  {% endfor %}
</ul>

{# Pending Bans nur solange BAN-Phase läuft #}
{% if isHost and not banPhaseDone %}
  <h4>Pending Bans LEFT → RIGHT</h4>
  <ul>
    {% for a in bansLeftToRightPending %}
      <li>Ban {{ a.slot_index }}: {{ a.resonator.name }} <em>(pending)</em></li>
    {% empty %}
      <li>None</li>
    {% endfor %}
  </ul>

  <h4>Pending Bans RIGHT → LEFT</h4>
  <ul>
    {% for a in bansRightToLeftPending %}
      <li>Ban {{ a.slot_index }}: {{ a.resonator.name }} <em>(pending)</em></li>
    {% empty %}
      <li>None</li>
    {% endfor %}
  </ul>
{% endif %}

<hr>

{# =======================
   PICKS (final immer anzeigen)
   ======================= #}

<h4>Picks LEFT</h4>
<ul>
  {% for a in picksLeft %}
    <li>{{ a.resonator.name }}</li>
  {% empty %}
    <li>None</li>
  {% endfor %}
</ul>

<h4>Picks RIGHT</h4>
<ul>
  {% for a in picksRight %}
    <li>{{ a.resonator.name }}</li>
  {% empty %}
    <li>None</li>
  {% endfor %}
</ul>

{# Pending Picks nur wenn BAN fertig und PICK-Phase läuft #}
{% if isHost and banPhaseDone and not pickPhaseDone %}
  <h4>Pending Picks LEFT</h4>
  <ul>
    {% for a in picksLeftPending %}
      <li>Pick {{ a.slot_index }}: {{ a.resonator.name }} <em>(pending)</em></li>
    {% empty %}
      <li>None</li>
    {% endfor %}
  </ul>

  <h4>Pending Picks RIGHT</h4>
  <ul>
    {% for a in picksRightPending %}
      <li>Pick {{ a.slot_index }}: {{ a.resonator.name }} <em>(pending)</em></li>
    {% empty %}
      <li>None</li>
    {% endfor %}
  </ul>
{% endif %}

<hr>

{% if not isHost and not pickPhaseDone %}
  {# =======================
     Player UI (Ban/Pick Forms)
     ======================= #}

  {% if banPhaseDone %}
    <p><b>Ban phase complete.</b></p>
    <p><b>Pick slot:</b> {{ currentPickSlot }} / {{ pickCount }}</p>
  {% else %}
    <p><b>Ban slot:</b> {{ currentBanSlot }} / {{ banCount }}</p>
  {% endif %}

  {% if banPending %}
    <p>
      You selected (pending): <b>{{ banPending.resonator.name }}</b><br>
      Waiting for opponent to confirm this slot…
    </p>
  {% endif %}

  {% if banForm %}
    <h4>Select your ban for slot {{ currentBanSlot }}</h4>

    {% if banAvailableCount == 0 %}
      <p><b>Keine Resonatoren verfügbar.</b></p>
    {% endif %}

    {% if userSide %}<p>You are: <b>{{ userSide }}</b></p>{% endif %}
    <form method="post" action="{% url 'matchConfirmBans' match.id %}">
      {% csrf_token %}
      <label for="resSearch"><b>Resonator suchen</b></label>
      <input id="resSearch" type="text" placeholder="Tippe zum Filtern..." autocomplete="off" style="width: 100%; max-width: 420px;">
      {{ banForm.as_p }}
      <button type="submit">Confirm ban</button>
    </form>
  {% endif %}

  {% if pickForm %}
    <h4>Select 3 picks (mirror picks allowed)</h4>
    {% if userSide %}<p>You are: <b>{{ userSide }}</b></p>{% endif %}
    <form method="post" action="{% url 'matchConfirmPicks' match.id %}">
      {% csrf_token %}
      {{ pickForm.as_p }}
      <button type="submit">Confirm picks</button>
    </form>
  {% endif %}
{% endif %}


<script>
(function () {
  const search = document.getElementById("resSearch");
  if (!search) return;

  // Findet ALLE selects im Draft-Block und filtert deren Optionen.
  // Das funktioniert, solange Resonator-Felder als <select> gerendert werden.
  const selects = Array.from(document.querySelectorAll("#draftRoot select"));

  // Original-Optionen merken, damit wir beim Leeren wiederherstellen können.
  const originals = new Map();
  selects.forEach(sel => {
    originals.set(sel, Array.from(sel.options).map(o => ({ value: o.value, text: o.text })));
  });

  function applyFilter(term) {
    const t = term.trim().toLowerCase();

    selects.forEach(sel => {
      const opts = originals.get(sel) || [];
      // leer räumen
      sel.innerHTML = "";

      // wieder aufbauen, gefiltert
      for (const o of opts) {
        if (!t || o.text.toLowerCase().includes(t)) {
          const opt = document.createElement("option");
          opt.value = o.value;
          opt.textContent = o.text;
          sel.appendChild(opt);
        }
      }
    });
  }

  search.addEventListener("input", () => applyFilter(search.value));
})();
</script>
