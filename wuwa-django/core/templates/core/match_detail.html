{% load timefmt %}

<h2>Match</h2>

{% if userSide %}
  <p>You are: <b>{{ userSide }}</b></p>
  <p>
    Opponent:
    {% if userSide == "LEFT" %}{{ match.player_right.name }}{% else %}{{ match.player_left.name }}{% endif %}
  </p>
{% endif %}

<p>
  {% if match.tournament %}[{{ match.tournament.name }}]{% endif %}
  {{ match.player_left.name }} vs {{ match.player_right.name }}
</p>
<p>Boss: {% if match.boss %}{{ match.boss.name }}{% else %}-{% endif %}</p>

<p>Status:
  {% if match.finished_at %}FINISHED
  {% elif match.started_at %}RUNNING
  {% else %}SCHEDULED
  {% endif %}
</p>

{% if isHost %}
  <form method="post" action="{% url 'hostMatchStart' match.id %}">
    {% csrf_token %}
    <button type="submit">Start</button>
  </form>

  {% if match.left_time_ms != None %}
    <p><em>Left Time: {{ match.left_time_ms|msToTime }}</em></p>
  {% endif %}
  {% if match.right_time_ms != None %}
    <p><em>Right Time: {{ match.right_time_ms|msToTime }}</em></p>
  {% endif %}
  {% if match.started_at and not match.finished_at %}
    {% if match.left_time_ms != None and match.right_time_ms != None %}
      <form method="post" action="{% url 'hostMatchFinish' match.id %}">
        {% csrf_token %}
        <button type="submit">Finish</button>
      </form>
    {% else %}
      <p><em>Waiting for both times...</em></p>
    {% endif %}
  {% endif %}
{% endif %}

<hr>

<div id="draftRoot" data-match-id="{{match.id}}">
  {% include "core/partials/match_draft.html" %}
</div>

<script>
(function () {
  const root = document.getElementById("draftRoot");
  const matchId = root.dataset.matchId;

  const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
  const wsUrl = wsProtocol + "://" + window.location.host + "/ws/match/" + matchId + "/draft/";

  async function refreshDraft() {
    const resp = await fetch("/match/" + matchId + "/draft-partial/", { credentials: "same-origin" });
    if (resp.ok) {
      root.innerHTML = await resp.text();
    }
  }

  function connect() {
    const socket = new WebSocket(wsUrl);

    socket.onmessage = function (event) {
      const data = JSON.parse(event.data);
      if (data.type === "refresh") {
        refreshDraft();
      }
    };

    socket.onopen = function () {
      refreshDraft(); // initial einmal ziehen
    };

    socket.onclose = function () {
      setTimeout(connect, 1500);
    };

    socket.onerror = function () {
      socket.close();
    };
  }

  connect();
})();
</script>

<hr>

{% if isPlayerInMatch and timeForm %}
  <h3>Submit time</h3>
  {% if match.boss %}
    <form method="post" action="{% url 'matchSubmitTime' match.id %}">
      {% csrf_token %}
      {{ timeForm.as_p }}
      <button type="submit">Submit</button>
    </form>
  {% else %}
    <p>No boss assigned yet.</p>
  {% endif %}
{% endif %}

{% if isHost %}
    <p><a href="{% url 'hostTournamentDetail' match.tournament_id %}">Back</a></p>
{% else %}
    <p><a href="{% url 'playerDashboard' %}">Back</a></p>
{% endif %}