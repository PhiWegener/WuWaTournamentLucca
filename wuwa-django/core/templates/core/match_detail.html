<h2>Match</h2>

{% if userSide %}
  <p>You are: <b>{{ userSide }}</b></p>
  <p>
    Opponent:
    {% if userSide == "LEFT" %}{{ match.player_right.name }}{% else %}{{ match.player_left.name }}{% endif %}
  </p>
{% endif %}

<p>
  {% if match.tournament %}[{{ match.tournament.name }}]{% endif %}
  {{ match.player_left.name }} vs {{ match.player_right.name }}
</p>
<p>Boss: {% if match.boss %}{{ match.boss.name }}{% else %}-{% endif %}</p>

<p>Status:
  {% if match.finished_at %}FINISHED
  {% elif match.started_at %}RUNNING
  {% else %}SCHEDULED
  {% endif %}
</p>

{% if isHost %}
  <h3>Host controls</h3>

  <form method="post" action="{% url 'hostMatchStart' match.id %}">
    {% csrf_token %}
    <button type="submit">Start</button>
  </form>

  <form method="post" action="{% url 'hostMatchFinish' match.id %}">
    {% csrf_token %}
    <button type="submit">Finish</button>
  </form>

  <h4>Winner & times</h4>
  <form method="post" action="{% url 'hostSetWinner' match.id %}">
    {% csrf_token %}
    {{ hostWinnerForm.as_p }}
    <button type="submit">Save</button>
  </form>
{% endif %}

<hr>

<div id="draftRoot" data-match-id="{{match.id}}">
  {% include "core/partials/match_draft.html" %}
</div>

<script>
(function () {
  const root = document.getElementById("draftRoot");
  const matchId = root.dataset.matchId;

  const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
  const wsUrl = wsProtocol + "://" + window.location.host + "/ws/match/" + matchId + "/draft/";

  let socket = null;

  function connect() {
    socket = new WebSocket(wsUrl);

    socket.onmessage = function (event) {
      const data = JSON.parse(event.data);

      if (data.type === "draftState" && data.html) {
        root.innerHTML = data.html;
      }
    };

    socket.onclose = function () {
      // Simple reconnect (optional)
      setTimeout(connect, 1500);
    };
  }

  connect();
})();
</script>

<hr>

{% if isPlayerInMatch %}
  <h3>Submit time</h3>
  {% if match.boss %}
    <form method="post" action="{% url 'matchSubmitTime' match.id %}">
      {% csrf_token %}
      {{ timeForm.as_p }}
      <button type="submit">Submit</button>
    </form>
  {% else %}
    <p>No boss assigned yet.</p>
  {% endif %}
{% endif %}

<p><a href="{% url 'playerDashboard' %}">Back</a></p>
